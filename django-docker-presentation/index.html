<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Running Django on Docker: a workflow and code</title>

    <meta name="description" content="Pallet &amp; Forklift &mdash; developing and deploying Web applications using Docker">
    <meta name="author" content="Alexey Kotlyarov, Ross Williamson">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.min.css">
    <link rel="stylesheet" href="./danni.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
      if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'bower_components/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
      }
    </script>

    <!--[if lt IE 9]>
    <script src="bower_components/reveal.js/lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">
      <div class="slides">
        <section data-markdown>
          <script type='text/template'>
            # Running Django on Docker
            ### a workflow and code

            Alexey Kotlyarov

            Danielle Madeley

            [ixa.io](http://ixa.io)
          </script>
        </section>

        <section data-background="https://farm4.staticflickr.com/3489/3866788424_3ee4a00967_b_d.jpg">
          <h2>The Problem</h2>

          <aside class="credit">
             Pallets &copy; 2014 philHendley, CC-BY-NC-SA
          </aside>
        </section>

        <section data-background="https://farm1.staticflickr.com/207/459608453_4d9c18359b_o_d.jpg">
          <h2>A diverse world of applications</h2>

          <aside class="credit">
            4-in-a-box &copy; 2007 cloud_nine, CC-BY-NC-SA
          </aside>

          <aside class="notes" data-markdown>
            <script type='text/template'>
             You have:

              * different dependencies between applications
              * different *versions* of dependencies between applications
              * different setups, i.e. choice of app server
              * different package managers
              * different Python versions
              * compiled sources
              * multiple languages
              * specific deps you can't control with virtualenv
            </script>
          </aside>
        </section>

        <section
          data-background="https://farm3.staticflickr.com/2866/12861161125_5f980a921d_b_d.jpg">
          <h2 style="color:steelblue;">Reproducable deployments</h2>

          <aside class="credit" style="color:steelblue;">
            Forklift bot &copy; 2014 Legozilla CC-BY-NC-SA
          </aside>

          <aside class="notes" data-markdown>
            <script type='text/template'>
              * Guaranteed identical releases to test, staging and production
              * Ability to deploy while PyPI it down
              * Rapid recovery after failure
              * Rapid scaleout when required
            </script>
          </aside>
        </section>

        <section
          data-background="http://i.ytimg.com/vi/Q5POuMHxW-0/maxresdefault.jpg">

          <aside class="notes" data-markdown>
            <script type='text/template'>
              * Docker is a framework for providing isolated containers on
                technology such as LXC
              * They can be memory and CPU constrained using the same cgroup
                commands
              * Containers are versioned and stored in a repository from where
                they can be pushed and pulled
              * Containers are immutable!
              * Containers can access external storage when configured to
                do so, enabling persistant storage
              * Containers are assigned local IPs only routable from the host
                but docker will forward ports exposed ports only when
                configured to do so
            </script>
          </aside>
        </section>

        <section data-background="#cfc">
          <img src="layers-diagram.svg"

          <aside class="notes" data-markdown>
            <script type='text/template'>
              * Docker containers are built up of layers
              * You have your base system, application dependencies and
                application, all immutable.
              * The files created by the running container will not exist when
                the container is cleaned up unless they were written to
                persistant storage.
              * This means your containers start in a known good state
              * You can share a container between different servers: test,
                staging, prod, and even start it on multiple servers to scale
                out
            </script>
          </aside>
        </section>

        <section data-background="https://farm1.staticflickr.com/163/340528570_8c2cb842dd_b_d.jpg">
          <h2>But there's no standards!</h2>

          <aside class="credit">
            Standard Oil &copy; 2006 Greenlight Designs CC-BY-NC
          </aside>

          <aside class="notes" data-markdown>
            <script type='text/template'>
              * Docker does not provide a standardised interface
              * What ports do I use, where do I store my data?
              * How do I do maintenance tasks?
              * We can borrow a lot of ideas here from 12factor, Heroku
                and Openshift
            </script>
          </aside>

        </section>

        <section
          data-background="https://farm8.staticflickr.com/7394/13996065906_fddba4ec84_b_d.jpg"
          style="color:#e11;">
          <h1>Pallet</h1>
          <h2>an interface for Docker containers</h2>
          <h3>https://github.com/infoxchange/pallet</h3>

          <aside class="notes" data-markdown>
            <script type='text/template'>
              * Pallet defines:
                * standard ports for things like app servers
                * standard internal mountpoints for external storage
                * standard environment variables for services, i.e. postgres,
                  memcache; and
                * standard entrypoints, i.e. docker run deploy,
                  docker run serve
            </script>
          </aside>
        </section>

        <section data-markdown>
          <script type='text/template'>
           ## What's in **deploy**?
            * database migrations
            * loading fixtures
            * install static content to static web server (CDN, Ceph, nginx,
              etc.)
          </script>
        </section>

        <section data-markdown>
          <script type='text/template'>
           ## What's in **serve**?
            * Start app server
            * Starting supporting services, e.g. Celery
          </script>
        </section>

        <section>
          <h2>Keep it lean</h2>

          <aside class="notes" data-markdown>
            <script type='text/template'>
              * We want to do as little as possible in these two steps,
                anything that can be done in the build should be done in the
                build.
              * i.e. installing deps
              * LESS -> CSS
            </script>
          </aside>
        </section>

        <section>
          <section>
            <h2>Building a Python application container</h2>
            <!-- TODO: I've just realised that we wanted to present this as live coding.
            Can be salvaged anyway? -->
          </section>

          <section data-markdown>
            <script type='text/template'>
              ```
              FROM debian/ubuntu/fedora/etc.
              RUN apt-get -qq update && apt-get -qq install \
                git mercurial \
                python python-virtualenv python-pip \
                ...
              ```
            </script>

            <aside class="notes" data-markdown>
              <script type='text/template'>
                * This will be cached. For security updates, this needs to be rebuilt
                  from scratch, bringing in the latest updates.
                * Unrestricted choice of version control, extra packages, etc.
              </script>
            </aside>
          </section>

          <section data-markdown>
            <script type='text/template'>
              ```
              RUN useradd -d /app -r app
              WORKDIR /app
              ```
            </script>

            <aside class="notes" data-markdown>
              <script type='text/template'>
                * Docker isn't guaranteed to be isolated from `root` inside the container.
              </script>
            </aside>
          </section>

          <section data-markdown>
            <script type='text/template'>
              ```
              ADD requirements.txt /app/requirements.txt
              RUN virtualenv python_env && pip install -r requirements.txt

              ADD . /app
              ```
            </script>

            <aside class="notes" data-markdown>
              <script type='text/template'>
                * Python dependencies change less often than code, so caching them separately
                  allows to skip the slow download & install process.
              </script>
            </aside>
          </section>

          <section data-markdown>
            <script type='text/template'>
              ```
              RUN echo "__version__ = \"`git describe`\"" > myapp/__version__.py

              RUN ./invoke.sh install

              ENTRYPOINT ["./invoke.sh"]

              EXPOSE 8000
              ```
            </script>
          </section>
        </section>

        <section data-background="#3F3F3F">
          <pre><code style="font-size:15pt;">
# default parameters
: ${APP_USER:=app}
: ${WEB_CONCURRENCY:=1}
export WEB_CONCURRENCY

if [ "x$(whoami)" != "x$APP_USER" ]; then
    # ensure we own our storage
    chown -R "$APP_USER" /static /storage

    # Call back into ourselves as the app user
    exec sudo -sE -u "$APP_USER" -- "$@"
else
    . ./startenv
    case "$1" in
        deploy)
            shift 1  # consume command from $@
            ./manage.py migrate "$@"
            ;;

        serve)
            gunicorn -w "$WEB_CONCURRENCY" \
              -b 0.0.0.0:8000 "${APP}.wsgi:application"
            ;;

        *)
            ./manage.py "$@"
            ;;
    esac
fi
            </code></pre>
        </section>

        <section
                 data-markdown="slides.md"
                 data-separator="^\n\n\n"
                 data-vertical="^\n\n"
                 data-notes="^Note:"
                 >
        </section>
    </div>

    <script src="bower_components/reveal.js/lib/js/head.min.js"></script>
    <script src="bower_components/reveal.js/js/reveal.min.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'bower_components/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'bower_components/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'bower_components/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

  </body>
</html>
